
=== Pixalytics

Pixalytics are developing an OGC-compliant Application Programming Interface (API) service, see <<Pixalytics_architecture>>, which will provide global information on droughts. The approach is to take global open data/datasets from organizations such as ESA/Copernicus, NASA/NOAA, and the WMO and combine meteorology, hydrology, and remote sensing data to produce ARD data based on a composite of different indicators. Where globally calculated drought indicators already exist, these are being used in preference to their re-calculation, although consistency and the presence of uncertainties are also being considered.

[[Pixalytics_architecture]]
.Pixalytics architecture
image::Pixalytics-architecture.png[Pixalytics-architecture]

Currently, the Standardized Precipitation Index (SPI) and Soil Moisture Anomaly (SMA) are being calculated using ERA5 reanalysis data from the Climate Data Store (CDS) of the Copernicus Climate Change Service. The API access is being set up following the Building Blocks for Climate Services (https://climateintelligence.github.io/smartduck-docs/) approach. Individual indices for precipitation (SPI), soil moisture (SMA), and vegetation drought are being worked on. Then, we will aim to combine them into a single view/indicator.

- Component: Drought indicator.

- Inputs: Meteorological data, including Precipitation, plus Land Surface Temperature, Soil Moisture, and Vegetation Index (or optical data to calculate it from).

- Outputs: Drought Indices - as a time-series dataset output in a choice of download formats: CSV, GeoJSON, CoverageJSON and NetCDF for point data and then COG for areas (to be developed).

- What other component(s) can interact with the component: a desire to link to visualization/DRI analysis components. A QGIS plugin has been updated to be able to perform a request and view the outputted JSON file (https://github.com/pixalytics-ltd/qgis-wps-plugin), and the Web Processing Service (WPS) link is https://api.pixalytics.com/climate/wps?request=GetCapabilities&service=wps

The WPS service remains in development/under improvement and currently provides access to individual precipitation and soil moisture related indices. Example Python query for a location in Canada (Latitude: 55.5 N Longitude: 99.1 W) for the SPI time series, with data for these dates/this location already cached, so runs quicker:

.Drought indicator calling code
----
    from owslib.wps import WebProcessingService, monitorExecution
    
	# contact the WPS client
    wps = WebProcessingService("http://api.pixalytics.com/climate/wps", skip_caps=True, verbose=False)
    
    # GetCapabilities
    wps.getcapabilities()

	# Execute
    inputs = [ ("start_date", '20200101'),
            ("end_date", '20221231'),
            ("latitude", '55.5'),
            ("longitude", '-99.1')]
    
    execution = wps.execute("drought", inputs, "output")

    monitorExecution(execution,download=True,filepath="temp.json")

    # Wait 5 seconds and check
    execution.checkStatus(sleepSecs=5)

    # show status
    print('Percent complete: {}'.format( execution.percentCompleted))

	# If there's an error print the error information
    for error in execution.errors:
        print("Error: ",error.code, error.locator, error.text)
----

- What OGC standards or formats does the component use and produce: Producing data on-the-fly using the WPS, so need to pull data through preferably an API route. The speed that the input data can be made available (i.e., extracting time-series subsets) governs the speed that the drought indicator provides data. To speed this up, input data that is not changing is being cached so that it runs significantly quicker when the API is called for a second time. 

<<Pixalytics_output>> shows an example of the output visualized within Python using Streamlit with the intermediate data (cached as NetCDF files) as input.

// This could be moved to a use case
[[Pixalytics_output]]
.Pixalytics output (Not the correct figure, to be updated)
image::Pixalytics-output-example.png[Pixalytics-output]

==== Drought Indicator Descriptions
The Drought Indicator API may be used to obtain any of the following indicators for a given latitude, longitude and time period.

_Standardised Precipitation Index_

The Standardised Precipitation Index (SPI) is a statistical value describing the amount of rainfall in a given time period relative to a longer time period for a given location. The SPI is a common drought indicator and provides an early warning of an impending drought. SPI is computed in monthly time intervals.

_Soil Moisture Anomaly_

The soil moisture anomaly (SMA) is another common indicator for agriculural drought, as it results from prolonged lack of rainfall and can preceed poor vegetation health. A surface SMA can be obtained from satellite data, or the SMA at greater depths into the soil from reanalyses or models. The SMA is computed relative to a long-term baseline period for a given location and is provided at a frequency of dekads.

_Fraction of Absorbed Photosynthetically Active Radiation_

The fraction of Absorbed Photosynthetically Active Radiation (fAPAR) is a satellite-derived value describing the proportion of solar radiation used directly by plants for growth and provides an indication of plant health. A drawback of using fAPAR as a drought indicator is that lower values can result from non-drought related events, such as disease. The fAPAR anomaly is computed relative to a long-term baseline perdiod for a given location and is provided at a freqency of dekads.

_The Combined Drought Indicator_

The Combined Drought Indicator (CDI, Sepulcre-Canto et al., 2012) provides an accessible measure of agricultural drought severity by assigning a Normal, Watch, Warning or Alert status to a particular region at a particular time. This allows a user without intimate knowledge of drought indicators to understand the current situation and take appropriate action.

The CDI is computed by combining statistical measures of precipitation (SPI), soil moisture (SMA) and vegetation health (FAPAR). <<Table 1>> shows how these are combined to give the different statuses. As an example, if the SPI, SMA and fAPAR are -1.2, 0.7, and -0.9 respectively, the CDI level would be 'Watch'. If all three are below -1, the CDI would be 'Alert 1'.

[%unnumbered]
.Combined Drought Indicator statuses, adapted from Sepulcre-Canto et al. (2012)
[width=100%,options="header"]
[cols="18h,~,10,10,10"]
|====================
|CDI    |Description      |SPI  |SMA  |FAPAR
|Normal |No drought       |     |     | 
|Watch  |Lower than usual rainfall |< -1 |     | 
|Warning|Dry soil following lower than usual rainfall |< -1 |< -1 |
|Alert 1|Vegetation stress following lower than usual rainfall and dry soil|< -1 |< -1 |< -1
|Alert 2|Vegetation stress following lower than usual rainfall (soil unaffected). |< -1 |     |< -1

|====================

==== Data Sources

_The Global Drought Observatory_

The Global Drought Observatory (GDO), owned by Copernicus Emergency Management Services, provides a global map of coarsely-gridded agricultural drought risk, along with a breakdown of the risk for each country. The drought risk is computed using the Combined Drought Indicator (CDI). The variables used to compute the CDI, and other drought-related variables, are provided in the user portal for download at https://edo.jrc.ec.europa.eu/gdo/php/index.php?id=2112, but the CDI itself is not available for download.

[[GDO-screenshot]]
.Global Drought Observatory Web Portal
image::GDO_screenshot.png[GDO-screenshot]

We obtain SMA and FAPAR from the GDO data download service. These are provided as netcdf files and contain pre-computed anomalies, so can be assimilated directly into the back-end.  The SMA uses a combination of the root soil moisture from the LISFLOOD model, the MODIS land surface temperature and the ESA CCI skin soil moisture (Cammaleri et al. 2016), and the FAPAR is from NASA optical imagery.


_ERA5 Reanalysis from ECMWF CDS_

The CDS portal provides an API interface to return either hourly or monthly averages of the ERA5 variables. Requesting the hourly data is necessary to compute anything which requires a frequency greater than monthly, which is the case for most drought indicators (e.g. SMA) which are in dekads. To ensure there is no anti-aliasing, the full 24hr dataset for each day of the month must be downloaded. This is very time-consuming and requests will fail if the number of datapoints exceeds the limit, which will occur for a period of 2 years or more, even for a single location.

There is a separate application, which can also be accessed via API, to return daily data. The CDS employs a queue management system, which determines the priority of each request based partially on the computational demand of the request. The daily data retrieval relies upon an underlying service to compute the daily statistics from the hourly data, demanding more resources than simply extracting the hourly or monthly data which are pre-computed. This means the request is held in the queue for a long time (up to hours), so there is no time benefit over using the hourly data. However, for a longer time-period which would be rejected if requested hourly, this provides a workaround. A further benefit of requesting daily, rather than hourly, data is that the downloaded file is smaller.

We compute SPI and SMA using variables from the CDS API. The SPI is computed from the total precipitation in monthly intervals. The SMA is computed from the soil water volume, which is available for 4 depth levels. The SMA for each depth is computed by calculating the z-score against a long term mean, using the same baseline time period as the SPI. The most relevant depth layer can then be selected by the user; for instance, a user interested in the health of crops with shallow roots may wish to access the surfacemost layer.

_ERA5 Reanalysis from AWS_

_NOAA?_

_SafeSoftware?_

==== Further work

- Forward modelling?






